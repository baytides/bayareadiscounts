<policies>
    <inbound>
        <base />
        
        <!-- Check subscription key exists -->
        <check-header name="Ocp-Apim-Subscription-Key" failed-check-httpcode="401" failed-check-error-message="Missing subscription key" ignore-case="true" />
        
        <!-- CORS policy -->
        <cors allow-credentials="false">
            <allowed-origins>
                <origin>https://bayareadiscounts.com</origin>
                <origin>https://www.bayareadiscounts.com</origin>
                <origin>https://wonderful-coast-09041e01e.2.azurestaticapps.net</origin>
                <origin>https://bayareadiscounts-web-b9gzhvbpdedgc2hn.z02.azurefd.net</origin>
            </allowed-origins>
            <allowed-methods>
                <method>GET</method>
                <method>POST</method>
                <method>OPTIONS</method>
            </allowed-methods>
            <allowed-headers>
                <header>Content-Type</header>
                <header>Accept</header>
                <header>Accept-Language</header>
                <header>Ocp-Apim-Subscription-Key</header>
            </allowed-headers>
            <expose-headers>
                <header>X-Cache</header>
            </expose-headers>
        </cors>
        
        <!-- Validate content type for POST requests -->
        <choose>
            <when condition="@(context.Request.Method == &quot;POST&quot;)">
                <check-header name="Content-Type" failed-check-httpcode="415" failed-check-error-message="Content-Type must be application/json" ignore-case="true">
                    <value>application/json</value>
                </check-header>
            </when>
        </choose>
    </inbound>
    
    <backend>
        <!-- Set timeout to prevent long-running requests -->
        <forward-request timeout="30" />
    </backend>
    
    <outbound>
        <base />
        
        <!-- Remove sensitive server headers -->
        <set-header name="X-Powered-By" exists-action="delete" />
        <set-header name="Server" exists-action="delete" />
        <set-header name="X-AspNet-Version" exists-action="delete" />
        
        <!-- Add security headers -->
        <set-header name="X-Content-Type-Options" exists-action="override">
            <value>nosniff</value>
        </set-header>
        <set-header name="X-Frame-Options" exists-action="override">
            <value>DENY</value>
        </set-header>
        <set-header name="Strict-Transport-Security" exists-action="override">
            <value>max-age=31536000; includeSubDomains</value>
        </set-header>
        
        <!-- Add API version header -->
        <set-header name="X-API-Version" exists-action="override">
            <value>1.0</value>
        </set-header>
    </outbound>
    
    <on-error>
        <base />
        <!-- Don't leak error details in production -->
        <set-header name="X-Error-Details" exists-action="delete" />
        <set-body>@{
            return new JObject(
                new JProperty("error", new JObject(
                    new JProperty("code", context.LastError.Source),
                    new JProperty("message", "An error occurred processing your request")
                ))
            ).ToString();
        }</set-body>
    </on-error>
</policies>
