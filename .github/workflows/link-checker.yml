name: Check Links

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'
  # Allow manual runs from Actions tab
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  linkChecker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prep lychee output directory
        run: mkdir -p lychee
      
      - name: Link Checker
        id: lychee
        uses: lycheeverse/lychee-action@v1
        with:
          # Check all markdown files; only fail on hard errors (e.g., 4xx).
          # Exclude transient/server/ratelimit errors from failure.
          args: >-
            --verbose --no-progress
            --accept 200,201,202,203,204,301,302,303,307,308
            --exclude-code 429,500,502,503,504,522,524
            --max-retries 3 --retry-wait-time 5
            './**/*.md'
          # Don't fail the workflow
          fail: false
          output: ./lychee/out.md
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      
      - name: Create Issue if Broken Links Found
        if: steps.lychee.outputs.lychee_exit_code != 0
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: 'ðŸ”— Broken Links Detected'
          content-filepath: ./lychee/out.md
          labels: broken-link, maintenance